# ç§’æ€åŠŸèƒ½æµ‹è¯•è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å®ç°äº†ä¼˜æƒ åˆ¸ç§’æ€åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š
- âœ… å…¨å±€å”¯ä¸€IDç”Ÿæˆå™¨
- âœ… ç§’æ€æ—¶é—´åˆ¤æ–­
- âœ… åº“å­˜æ‰£å‡ï¼ˆä¹è§‚é”é˜²æ­¢è¶…å–ï¼‰
- âœ… ä¸€äººä¸€å•æ ¡éªŒ
- âœ… äº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§

## ğŸ”§ å‡†å¤‡å·¥ä½œ

### 1. æ•°æ®åº“å‡†å¤‡

ç¡®ä¿å·²ç»å¯¼å…¥SQLæ–‡ä»¶ï¼Œè¡¨ç»“æ„å¦‚ä¸‹ï¼š

```sql
-- ç§’æ€åˆ¸è¡¨
CREATE TABLE tb_seckill_voucher (
    voucher_id BIGINT PRIMARY KEY,
    stock INT NOT NULL,
    create_time DATETIME,
    begin_time DATETIME,
    end_time DATETIME,
    update_time DATETIME
);

-- ä¼˜æƒ åˆ¸è®¢å•è¡¨
CREATE TABLE tb_voucher_order (
    id BIGINT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    voucher_id BIGINT NOT NULL,
    pay_type TINYINT,
    status TINYINT,
    create_time DATETIME,
    pay_time DATETIME,
    use_time DATETIME,
    refund_time DATETIME,
    update_time DATETIME
);
```

### 2. æ’å…¥æµ‹è¯•æ•°æ®

```sql
-- æ’å…¥ä¸€ä¸ªç§’æ€åˆ¸ï¼ˆID=1ï¼Œåº“å­˜100ï¼Œå½“å‰æ—¶é—´å¯ä»¥ç§’æ€ï¼‰
INSERT INTO tb_seckill_voucher (voucher_id, stock, begin_time, end_time, create_time, update_time)
VALUES (
    1, 
    100, 
    NOW(), 
    DATE_ADD(NOW(), INTERVAL 1 HOUR),  -- 1å°æ—¶åç»“æŸ
    NOW(), 
    NOW()
);
```

### 3. å¯åŠ¨Redis

```bash
redis-server
```

### 4. å¯åŠ¨åº”ç”¨

```bash
mvn spring-boot:run
```

---

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•1ï¼šæ­£å¸¸ç§’æ€

**è¯·æ±‚ï¼š**
```bash
POST http://localhost:8081/voucher-order/seckill/1
Headers:
  authorization: {ä½ çš„token}
```

**é¢„æœŸç»“æœï¼š**
```json
{
  "success": true,
  "data": 1729508419584000000  // è®¢å•ID
}
```

**éªŒè¯ï¼š**
```sql
-- æŸ¥çœ‹åº“å­˜æ˜¯å¦æ‰£å‡
SELECT stock FROM tb_seckill_voucher WHERE voucher_id = 1;  -- åº”è¯¥å˜æˆ99

-- æŸ¥çœ‹è®¢å•æ˜¯å¦åˆ›å»º
SELECT * FROM tb_voucher_order WHERE voucher_id = 1;
```

---

### æµ‹è¯•2ï¼šé‡å¤è´­ä¹°ï¼ˆä¸€äººä¸€å•ï¼‰

**è¯·æ±‚ï¼š** åŒä¸€ä¸ªç”¨æˆ·å†æ¬¡è¯·æ±‚ç§’æ€æ¥å£

**é¢„æœŸç»“æœï¼š**
```json
{
  "success": false,
  "errorMsg": "æ¯äººé™è´­ä¸€å¼ ï¼"
}
```

---

### æµ‹è¯•3ï¼šåº“å­˜ä¸è¶³

**å‡†å¤‡ï¼š** å°†åº“å­˜æ”¹ä¸º0
```sql
UPDATE tb_seckill_voucher SET stock = 0 WHERE voucher_id = 1;
```

**è¯·æ±‚ï¼š** å†æ¬¡ç§’æ€

**é¢„æœŸç»“æœï¼š**
```json
{
  "success": false,
  "errorMsg": "åº“å­˜ä¸è¶³ï¼"
}
```

---

### æµ‹è¯•4ï¼šç§’æ€æœªå¼€å§‹

**å‡†å¤‡ï¼š** å°†å¼€å§‹æ—¶é—´è®¾ç½®ä¸ºæœªæ¥
```sql
UPDATE tb_seckill_voucher 
SET begin_time = DATE_ADD(NOW(), INTERVAL 1 HOUR) 
WHERE voucher_id = 1;
```

**é¢„æœŸç»“æœï¼š**
```json
{
  "success": false,
  "errorMsg": "ç§’æ€å°šæœªå¼€å§‹ï¼"
}
```

---

### æµ‹è¯•5ï¼šç§’æ€å·²ç»“æŸ

**å‡†å¤‡ï¼š** å°†ç»“æŸæ—¶é—´è®¾ç½®ä¸ºè¿‡å»
```sql
UPDATE tb_seckill_voucher 
SET end_time = DATE_SUB(NOW(), INTERVAL 1 HOUR) 
WHERE voucher_id = 1;
```

**é¢„æœŸç»“æœï¼š**
```json
{
  "success": false,
  "errorMsg": "ç§’æ€å·²ç»ç»“æŸï¼"
}
```

---

## ğŸš€ å¹¶å‘æµ‹è¯•ï¼ˆJMeterï¼‰

### æµ‹è¯•åœºæ™¯ï¼š100äººåŒæ—¶æŠ¢è´­10å¼ åˆ¸

**å‡†å¤‡æ•°æ®ï¼š**
```sql
UPDATE tb_seckill_voucher SET stock = 10 WHERE voucher_id = 1;
DELETE FROM tb_voucher_order WHERE voucher_id = 1;
```

**JMeteré…ç½®ï¼š**
```
çº¿ç¨‹ç»„ï¼š
- çº¿ç¨‹æ•°ï¼š100
- Ramp-Up: 0ï¼ˆç«‹å³å¯åŠ¨ï¼‰
- å¾ªç¯æ¬¡æ•°ï¼š1

HTTPè¯·æ±‚ï¼š
- æ–¹æ³•ï¼šPOST
- è·¯å¾„ï¼š/voucher-order/seckill/1
- Headersï¼šauthorization: {token}
```

**é¢„æœŸç»“æœï¼š**
- âœ… æˆåŠŸåˆ›å»º10ä¸ªè®¢å•
- âœ… 90ä¸ªè¯·æ±‚å¤±è´¥ï¼ˆåº“å­˜ä¸è¶³æˆ–å·²è´­ä¹°ï¼‰
- âœ… æœ€ç»ˆåº“å­˜ä¸º0
- âœ… æ— è¶…å–ï¼ˆè®¢å•æ•° = 10ï¼‰

**éªŒè¯SQLï¼š**
```sql
-- æŸ¥çœ‹è®¢å•æ•°ï¼ˆåº”è¯¥æ˜¯10ï¼‰
SELECT COUNT(*) FROM tb_voucher_order WHERE voucher_id = 1;

-- æŸ¥çœ‹åº“å­˜ï¼ˆåº”è¯¥æ˜¯0ï¼‰
SELECT stock FROM tb_seckill_voucher WHERE voucher_id = 1;
```

---

## ğŸ” æ ¸å¿ƒä»£ç è¯´æ˜

### 1. å…¨å±€å”¯ä¸€IDç”Ÿæˆå™¨

**ä½ç½®ï¼š** `RedisIdWorker.java`

**åŸç†ï¼š**
```
ID = æ—¶é—´æˆ³(31ä½) + åºåˆ—å·(32ä½)
```

**æµ‹è¯•ï¼š**
```java
@Test
void testIdWorker() throws InterruptedException {
    CountDownLatch latch = new CountDownLatch(300);
    Runnable task = () -> {
        for (int i = 0; i < 100; i++) {
            long id = redisIdWorker.nextId("order");
            System.out.println("id = " + id);
        }
        latch.countDown();
    };
    
    long begin = System.currentTimeMillis();
    for (int i = 0; i < 300; i++) {
        new Thread(task).start();
    }
    latch.await();
    long end = System.currentTimeMillis();
    
    System.out.println("time = " + (end - begin));
}
```

---

### 2. ä¹è§‚é”é˜²æ­¢è¶…å–

**SQLï¼š**
```sql
UPDATE tb_seckill_voucher 
SET stock = stock - 1 
WHERE voucher_id = ? AND stock > 0
```

**å…³é”®ç‚¹ï¼š**
- `stock > 0` æ˜¯ä¹è§‚é”çš„æ ¸å¿ƒ
- åªæœ‰åº“å­˜å¤§äº0æ—¶æ‰ä¼šæ›´æ–°æˆåŠŸ
- æ•°æ®åº“ä¿è¯åŸå­æ€§

---

### 3. synchronizedé”ä¿è¯ä¸€äººä¸€å•

**ä»£ç ï¼š**
```java
synchronized (userId.toString().intern()) {
    // æŸ¥è¯¢ + åˆ›å»ºè®¢å•
}
```

**ä¸ºä»€ä¹ˆç”¨ intern()ï¼Ÿ**
- `userId.toString()` æ¯æ¬¡éƒ½æ˜¯æ–°å¯¹è±¡
- `intern()` è¿”å›å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­çš„å¯¹è±¡
- ç›¸åŒçš„ç”¨æˆ·IDä½¿ç”¨åŒä¸€æŠŠé”

---

### 4. Springäº‹åŠ¡ä»£ç†

**é—®é¢˜ï¼š** ç›´æ¥è°ƒç”¨ `this.createVoucherOrder()` äº‹åŠ¡ä¸ç”Ÿæ•ˆ

**åŸå› ï¼š** Springäº‹åŠ¡æ˜¯åŸºäºAOPä»£ç†å®ç°çš„ï¼Œ`this` æ˜¯å½“å‰å¯¹è±¡ï¼Œä¸æ˜¯ä»£ç†å¯¹è±¡

**è§£å†³ï¼š**
```java
// è·å–ä»£ç†å¯¹è±¡
IVoucherOrderService proxy = (IVoucherOrderService) AopContext.currentProxy();
// é€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨ï¼Œäº‹åŠ¡ç”Ÿæ•ˆ
return proxy.createVoucherOrder(voucherId);
```

**é…ç½®ï¼š**
```java
@EnableAspectJAutoProxy(exposeProxy = true)  // æš´éœ²ä»£ç†å¯¹è±¡
```

---

## âš ï¸ å·²çŸ¥é™åˆ¶

### 1. synchronizedåªèƒ½åœ¨å•æœºç¯å¢ƒä¸‹ä¿è¯ä¸€äººä¸€å•

**é—®é¢˜ï¼š** é›†ç¾¤ç¯å¢ƒä¸‹ï¼Œä¸åŒJVMçš„é”ä¸äº’æ–¥

**è§£å†³æ–¹æ¡ˆï¼š** ä½¿ç”¨åˆ†å¸ƒå¼é”ï¼ˆRedis/Redissonï¼‰

### 2. ä¹è§‚é”å¯èƒ½å¯¼è‡´å¤±è´¥ç‡è¾ƒé«˜

**åœºæ™¯ï¼š** åº“å­˜å……è¶³ï¼Œä½†å› ä¸ºå¹¶å‘å†²çªå¯¼è‡´æ›´æ–°å¤±è´¥

**æ”¹è¿›æ–¹æ¡ˆï¼š**
```sql
-- æ”¹è¿›ï¼šåªè¦åº“å­˜å¤§äºç­‰äºè¦æ‰£å‡çš„æ•°é‡å°±å¯ä»¥
WHERE voucher_id = ? AND stock >= ?
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®ï¼ˆä¸‹ä¸€é˜¶æ®µï¼‰

### 1. ä½¿ç”¨Redisé¢„åˆ¤

```java
// ç§’æ€å¼€å§‹å‰ï¼Œå°†åº“å­˜åŠ è½½åˆ°Redis
stringRedisTemplate.opsForValue().set("seckill:stock:" + voucherId, stock);

// ç§’æ€æ—¶å…ˆåœ¨Redisåˆ¤æ–­
Long stock = stringRedisTemplate.opsForValue().get("seckill:stock:" + voucherId);
if(stock <= 0) {
    return Result.fail("åº“å­˜ä¸è¶³");
}
```

### 2. å¼‚æ­¥ä¸‹å•

```java
// Redisåˆ¤æ–­é€šè¿‡åï¼Œå‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—
rabbitTemplate.convertAndSend("seckill.order", order);

// å¼‚æ­¥æ¶ˆè´¹è€…å¤„ç†è®¢å•å…¥åº“
@RabbitListener(queues = "seckill.order")
public void handleOrder(VoucherOrder order) {
    // å…¥åº“æ“ä½œ
}
```

### 3. ä½¿ç”¨Luaè„šæœ¬

```lua
-- åŸå­æ€§åˆ¤æ–­åº“å­˜ + æ‰£å‡ + è®°å½•ç”¨æˆ·
if(redis.call('get', KEYS[1]) > 0) then
    redis.call('incrby', KEYS[1], -1)
    redis.call('sadd', KEYS[2], ARGV[1])
    return 0
else
    return 1
end
```

---

## ğŸ“š å­¦ä¹ è¦ç‚¹

1. âœ… **å…¨å±€å”¯ä¸€IDç”Ÿæˆ** - é›ªèŠ±ç®—æ³•æ€æƒ³
2. âœ… **ä¹è§‚é”** - CASæœºåˆ¶é˜²æ­¢è¶…å–
3. âœ… **synchronized** - JVMé”ä¿è¯ä¸€äººä¸€å•
4. âœ… **Springäº‹åŠ¡** - ä»£ç†æ¨¡å¼åŸç†
5. âœ… **å¹¶å‘æµ‹è¯•** - JMeterå‹æµ‹

---

æ­å–œï¼ğŸ‰ ä½ å·²ç»å®Œæˆäº†ç§’æ€åŠŸèƒ½çš„åŸºç¡€ç‰ˆæœ¬å®ç°ï¼

