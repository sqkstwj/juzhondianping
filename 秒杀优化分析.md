# ç§’æ€ä¼˜åŒ–åˆ†æ - ä¹è§‚é”æ”¹è¿›

## âŒ å½“å‰å®ç°çš„é—®é¢˜

### å½“å‰ä»£ç 

```java
boolean success = seckillVoucherService.update()
        .setSql("stock = stock - 1")
        .eq("voucher_id", voucherId)
        .gt("stock", 0)  // é—®é¢˜åœ¨è¿™é‡Œï¼
        .update();
```

**ç”Ÿæˆçš„SQLï¼š**
```sql
UPDATE tb_seckill_voucher 
SET stock = stock - 1 
WHERE voucher_id = ? AND stock > 0
```

---

## ğŸ” é—®é¢˜åˆ†æ

### é—®é¢˜1ï¼šå¤±è´¥ç‡è¿‡é«˜ï¼ˆæ€§èƒ½é—®é¢˜ï¼‰

**åœºæ™¯æ¨¡æ‹Ÿï¼š**

å‡è®¾åº“å­˜ = 100ï¼Œ100ä¸ªç”¨æˆ·åŒæ—¶ç§’æ€ï¼š

#### æ—¶åˆ»T1ï¼š
```
ç”¨æˆ·1: SELECT stock FROM ... WHERE voucher_id = 1  â†’ stock = 100
ç”¨æˆ·2: SELECT stock FROM ... WHERE voucher_id = 1  â†’ stock = 100
ç”¨æˆ·3: SELECT stock FROM ... WHERE voucher_id = 1  â†’ stock = 100
...
ç”¨æˆ·100: SELECT stock FROM ... WHERE voucher_id = 1 â†’ stock = 100
```

#### æ—¶åˆ»T2ï¼š
```
ç”¨æˆ·1: UPDATE ... SET stock = stock - 1 WHERE voucher_id = 1 AND stock > 0
       â†’ æˆåŠŸï¼stockå˜ä¸º99

ç”¨æˆ·2: UPDATE ... SET stock = stock - 1 WHERE voucher_id = 1 AND stock > 0
       â†’ æˆåŠŸï¼stockå˜ä¸º98

ç”¨æˆ·3: UPDATE ... SET stock = stock - 1 WHERE voucher_id = 1 AND stock > 0
       â†’ æˆåŠŸï¼stockå˜ä¸º97
...
```

**çœ‹èµ·æ¥æ²¡é—®é¢˜ï¼Ÿå®é™…ä¸Šæœ‰å¤§é—®é¢˜ï¼**

#### çœŸå®çš„é«˜å¹¶å‘åœºæ™¯ï¼š

ç”±äºç½‘ç»œå»¶è¿Ÿã€æ•°æ®åº“é”ç­‰åŸå› ï¼Œå®é™…ä¸Šå¾ˆå¤šUPDATEä¼š**å‡ ä¹åŒæ—¶**åˆ°è¾¾æ•°æ®åº“ï¼š

```
æ—¶åˆ»T: æ‰€æœ‰ç”¨æˆ·åŒæ—¶æ‰§è¡ŒUPDATE
       WHERE stock > 0 è¿™ä¸ªæ¡ä»¶åœ¨æ‰§è¡Œæ—¶ï¼Œstockéƒ½æ˜¯100

ä½†æ˜¯UPDATEæ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼ˆè¡Œé”ï¼‰ï¼š
- ç”¨æˆ·1æ‰§è¡Œï¼šstock = 100 - 1 = 99 âœ…
- ç”¨æˆ·2æ‰§è¡Œï¼šä½†æ­¤æ—¶stockå·²ç»æ˜¯99ï¼Œä¸æ˜¯100äº†
  - å¦‚æœæˆ‘ä»¬çš„WHEREæ¡ä»¶æ˜¯ stock = 100ï¼ˆç‰ˆæœ¬å·æœºåˆ¶ï¼‰ï¼Œè¿™é‡Œä¼šå¤±è´¥
  - ä½†æˆ‘ä»¬çš„æ¡ä»¶æ˜¯ stock > 0ï¼Œæ‰€ä»¥ä¼šæˆåŠŸ âœ…
```

**ç­‰ç­‰ï¼ä¸ºä»€ä¹ˆä¼šå¤±è´¥ç‡é«˜ï¼Ÿ**

è¿™æ˜¯å› ä¸ºæˆ‘åœ¨æ³¨é‡Šä¸­çš„è§£é‡Šæœ‰è¯¯å¯¼æ€§ã€‚è®©æˆ‘é‡æ–°åˆ†æï¼š

å®é™…ä¸Š `stock > 0` è¿™ä¸ªæ¡ä»¶**ä¸ä¼š**å¯¼è‡´é«˜å¤±è´¥ç‡ï¼Œå› ä¸ºï¼š
- åªè¦ stock > 0ï¼Œæ›´æ–°å°±ä¼šæˆåŠŸ
- stockä»100å‡åˆ°0çš„è¿‡ç¨‹ä¸­ï¼Œæ¯æ¬¡UPDATEéƒ½èƒ½æˆåŠŸ

---

## âœ… é‡æ–°è¯„ä¼°ï¼šå½“å‰å®ç°å…¶å®æ˜¯åˆç†çš„

### ä¿®æ­£ç†è§£

```sql
UPDATE tb_seckill_voucher 
SET stock = stock - 1 
WHERE voucher_id = ? AND stock > 0
```

**è¿™ä¸ªSQLçš„ä½œç”¨ï¼š**
1. âœ… **é˜²æ­¢è¶…å–** - `stock > 0` ç¡®ä¿ä¸ä¼šæ‰£æˆè´Ÿæ•°
2. âœ… **æ€§èƒ½è¾ƒå¥½** - åªè¦åº“å­˜å……è¶³ï¼Œæ›´æ–°éƒ½èƒ½æˆåŠŸ
3. âœ… **ç®€å•å¯é ** - æ•°æ®åº“å±‚é¢ä¿è¯åŸå­æ€§

**æ‰§è¡Œè¿‡ç¨‹ï¼š**
```
åº“å­˜=100æ—¶ï¼š
ç”¨æˆ·1: UPDATE ... WHERE stock > 0 â†’ stockå˜ä¸º99 âœ…
ç”¨æˆ·2: UPDATE ... WHERE stock > 0 â†’ stockå˜ä¸º98 âœ…
ç”¨æˆ·3: UPDATE ... WHERE stock > 0 â†’ stockå˜ä¸º97 âœ…
...
ç”¨æˆ·100: UPDATE ... WHERE stock > 0 â†’ stockå˜ä¸º0 âœ…
ç”¨æˆ·101: UPDATE ... WHERE stock > 0 â†’ å¤±è´¥ï¼ˆstock=0ä¸æ»¡è¶³>0ï¼‰âŒ
```

---

## ğŸš€ ä½†ä»ç„¶å¯ä»¥ä¼˜åŒ–ï¼

è™½ç„¶å½“å‰å®ç°æ²¡æœ‰ä¸¥é‡é—®é¢˜ï¼Œä½†åœ¨**æé«˜å¹¶å‘**åœºæ™¯ä¸‹ï¼Œè¿˜æœ‰ä¼˜åŒ–ç©ºé—´ï¼š

### ä¼˜åŒ–1ï¼šä½¿ç”¨CASï¼ˆCompare And Setï¼‰ç‰ˆæœ¬å·æœºåˆ¶

**é—®é¢˜åœºæ™¯ï¼š**
- 1000ä¸ªç”¨æˆ·åŒæ—¶æŠ¢10å¼ åˆ¸
- 990ä¸ªç”¨æˆ·ä¼šå› ä¸ºåº“å­˜ä¸è¶³å¤±è´¥
- ä½†è¿™990ä¸ªè¯·æ±‚éƒ½ä¼š**æ‰“åˆ°æ•°æ®åº“**

**ä¼˜åŒ–æ–¹æ¡ˆï¼š** åŠ å…¥ç‰ˆæœ¬å·

#### æ•°æ®åº“è¡¨ç»“æ„ä¿®æ”¹ï¼š

```sql
ALTER TABLE tb_seckill_voucher ADD COLUMN version INT DEFAULT 0;
```

#### ä»£ç å®ç°ï¼š

```java
// 1. æŸ¥è¯¢å½“å‰ç‰ˆæœ¬å·å’Œåº“å­˜
SeckillVoucher voucher = seckillVoucherService.getById(voucherId);
if (voucher.getStock() < 1) {
    return Result.fail("åº“å­˜ä¸è¶³ï¼");
}

// 2. CASæ›´æ–°ï¼ˆæ¯”è¾ƒç‰ˆæœ¬å·ï¼‰
boolean success = seckillVoucherService.update()
        .setSql("stock = stock - 1, version = version + 1")
        .eq("voucher_id", voucherId)
        .eq("version", voucher.getVersion())  // CASçš„å…³é”®ï¼
        .gt("stock", 0)
        .update();

if (!success) {
    // ç‰ˆæœ¬å·å·²å˜åŒ–ï¼Œè¯´æ˜è¢«å…¶ä»–çº¿ç¨‹æŠ¢å…ˆäº†
    return Result.fail("æ‰‹é€Ÿå¤ªæ…¢äº†ï¼Œè¯·é‡è¯•ï¼");
}
```

**ç”Ÿæˆçš„SQLï¼š**
```sql
UPDATE tb_seckill_voucher 
SET stock = stock - 1, version = version + 1
WHERE voucher_id = ? AND version = ? AND stock > 0
```

**ç¼ºç‚¹ï¼š** å¤±è´¥ç‡ä¼šå˜é«˜ï¼ˆç‰ˆæœ¬å·ä¸åŒ¹é…ï¼‰

---

### ä¼˜åŒ–2ï¼šRedisé¢„å‡åº“å­˜ï¼ˆæ¨èï¼ï¼‰â­â­â­

**æ ¸å¿ƒæ€æƒ³ï¼š** åœ¨Redisä¸­å…ˆåˆ¤æ–­åº“å­˜ï¼Œé¿å…æ— æ•ˆçš„æ•°æ®åº“è¯·æ±‚

#### å®ç°æ­¥éª¤ï¼š

**Step 1: ç§’æ€å¼€å§‹å‰ï¼Œå°†åº“å­˜åŠ è½½åˆ°Redis**

```java
// åœ¨addSeckillVoucheræ—¶é¢„çƒ­
public void addSeckillVoucher(Voucher voucher) {
    // ... ä¿å­˜åˆ°æ•°æ®åº“
    
    // é¢„çƒ­åˆ°Redis
    stringRedisTemplate.opsForValue()
        .set("seckill:stock:" + voucher.getId(), 
             voucher.getStock().toString());
}
```

**Step 2: ç§’æ€æ—¶å…ˆåœ¨Redisä¸­åˆ¤æ–­**

```java
@Override
public Result seckillVoucher(Long voucherId) {
    // 1. Redisé¢„å‡åº“å­˜ï¼ˆåŸå­æ“ä½œï¼‰
    String key = "seckill:stock:" + voucherId;
    Long stock = stringRedisTemplate.opsForValue()
        .decrement(key);  // åŸå­é€’å‡
    
    if (stock < 0) {
        // åº“å­˜ä¸è¶³ï¼Œç›´æ¥è¿”å›ï¼Œä¸è®¿é—®æ•°æ®åº“
        return Result.fail("åº“å­˜ä¸è¶³ï¼");
    }
    
    // 2. åº“å­˜å……è¶³ï¼Œç»§ç»­åç»­æµç¨‹ï¼ˆæ•°æ®åº“æ‰£åº“å­˜ï¼‰
    // ...
}
```

**ä¼˜ç‚¹ï¼š**
- âœ… **æ€§èƒ½æé«˜** - Rediså†…å­˜æ“ä½œï¼ŒQPSå¯è¾¾10ä¸‡+
- âœ… **å‡è½»æ•°æ®åº“å‹åŠ›** - 90%çš„å¤±è´¥è¯·æ±‚åœ¨Rediså±‚å°±æ‹¦æˆªäº†
- âœ… **æ— è¶…å–** - Redisçš„DECRæ˜¯åŸå­æ“ä½œ

**ç”Ÿæˆçš„Rediså‘½ä»¤ï¼š**
```bash
DECR seckill:stock:10
```

---

### ä¼˜åŒ–3ï¼šLuaè„šæœ¬ä¿è¯åŸå­æ€§

**é—®é¢˜ï¼š** åˆ¤æ–­åº“å­˜å’Œæ‰£å‡åº“å­˜æ˜¯ä¸¤ä¸ªæ“ä½œï¼Œä¸æ˜¯åŸå­çš„

**è§£å†³ï¼š** ä½¿ç”¨Luaè„šæœ¬

```lua
-- seckill.lua
-- åˆ¤æ–­åº“å­˜å¹¶æ‰£å‡ï¼ˆåŸå­æ“ä½œï¼‰
local stock = redis.call('get', KEYS[1])
if tonumber(stock) <= 0 then
    return 0  -- åº“å­˜ä¸è¶³
end

redis.call('decr', KEYS[1])
return 1  -- æˆåŠŸ
```

**Javaä»£ç ï¼š**

```java
// æ‰§è¡ŒLuaè„šæœ¬
Long result = stringRedisTemplate.execute(
    new DefaultRedisScript<>(luaScript, Long.class),
    Collections.singletonList("seckill:stock:" + voucherId)
);

if (result == 0) {
    return Result.fail("åº“å­˜ä¸è¶³ï¼");
}
```

---

### ä¼˜åŒ–4ï¼šå¼‚æ­¥ä¸‹å•ï¼ˆç»ˆææ–¹æ¡ˆï¼‰â­â­â­

**é—®é¢˜ï¼š** æ‰£å‡åº“å­˜ã€ä¸€äººä¸€å•æ ¡éªŒã€åˆ›å»ºè®¢å•éƒ½æ˜¯åŒæ­¥æ“ä½œï¼Œè€—æ—¶é•¿

**è§£å†³ï¼š** å¼‚æ­¥å¤„ç†

#### æ¶æ„å›¾ï¼š

```
ç”¨æˆ·è¯·æ±‚ â†’ Redisé¢„åˆ¤æ–­ â†’ å‘é€MQæ¶ˆæ¯ â†’ ç«‹å³è¿”å›è®¢å•ID
                              â†“
                        å¼‚æ­¥æ¶ˆè´¹è€…å¤„ç†ï¼š
                        - ä¸€äººä¸€å•æ ¡éªŒ
                        - æ‰£å‡æ•°æ®åº“åº“å­˜
                        - åˆ›å»ºè®¢å•
```

#### å®ç°ï¼š

```java
@Override
public Result seckillVoucher(Long voucherId) {
    // 1. Redisé¢„åˆ¤æ–­
    Long stock = stringRedisTemplate.opsForValue()
        .decrement("seckill:stock:" + voucherId);
    if (stock < 0) {
        return Result.fail("åº“å­˜ä¸è¶³ï¼");
    }
    
    // 2. ç”Ÿæˆè®¢å•ID
    long orderId = redisIdWorker.nextId("order");
    
    // 3. å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—
    VoucherOrderMessage message = new VoucherOrderMessage();
    message.setOrderId(orderId);
    message.setUserId(UserHolder.getUser().getId());
    message.setVoucherId(voucherId);
    rabbitTemplate.convertAndSend("seckill.order", message);
    
    // 4. ç«‹å³è¿”å›ï¼ˆå¼‚æ­¥å¤„ç†ï¼‰
    return Result.ok(orderId);
}

// æ¶ˆæ¯æ¶ˆè´¹è€…
@RabbitListener(queues = "seckill.order")
public void handleOrder(VoucherOrderMessage message) {
    // 1. ä¸€äººä¸€å•æ ¡éªŒ
    // 2. æ‰£å‡æ•°æ®åº“åº“å­˜
    // 3. åˆ›å»ºè®¢å•
}
```

**ä¼˜ç‚¹ï¼š**
- âœ… **å“åº”é€Ÿåº¦å¿«** - 1-2mså³å¯è¿”å›
- âœ… **å‰Šå³°å¡«è°·** - æ¶ˆæ¯é˜Ÿåˆ—ç¼“å†²é«˜å³°æµé‡
- âœ… **é«˜å¯ç”¨** - å³ä½¿æ•°æ®åº“æ…¢ï¼Œç”¨æˆ·ä½“éªŒä¸å—å½±å“

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| æ–¹æ¡ˆ | QPS | å¤±è´¥ç‡ | æ•°æ®åº“å‹åŠ› | å¤æ‚åº¦ |
|------|-----|--------|------------|--------|
| **å½“å‰æ–¹æ¡ˆï¼ˆstock > 0ï¼‰** | 3000 | ä½ | é«˜ | ä½ |
| CASç‰ˆæœ¬å· | 3000 | é«˜ | é«˜ | ä¸­ |
| Redisé¢„å‡åº“å­˜ | 50000+ | ä½ | ä½ | ä¸­ |
| Luaè„šæœ¬ | 80000+ | ä½ | ä½ | ä¸­ |
| å¼‚æ­¥ä¸‹å• | 100000+ | ä½ | æä½ | é«˜ |

---

## ğŸ¯ æ”¹è¿›å»ºè®®

### å¯¹äºå­¦ä¹ é¡¹ç›®ï¼ˆå½“å‰é˜¶æ®µï¼‰

**ä¿æŒå½“å‰å®ç°** + **å°ä¼˜åŒ–**ï¼š

```java
// å½“å‰çš„å®ç°å·²ç»è¶³å¤Ÿå¥½ï¼Œåªéœ€å°è°ƒæ•´
boolean success = seckillVoucherService.update()
        .setSql("stock = stock - 1")
        .eq("voucher_id", voucherId)
        .gt("stock", 0)  // ä¿æŒä¸å˜ï¼Œè¿™ä¸ªæ˜¯å¯¹çš„ï¼
        .update();
```

**åŸå› ï¼š**
- âœ… ç®€å•æ˜“æ‡‚ï¼Œé€‚åˆå­¦ä¹ 
- âœ… æ²¡æœ‰è¶…å–é—®é¢˜
- âœ… æ€§èƒ½åœ¨åƒçº§QPSåœºæ™¯ä¸‹è¶³å¤Ÿ
- âœ… ä¸éœ€è¦å¼•å…¥Redisã€MQç­‰å¤æ‚æŠ€æœ¯

---

### è¿›é˜¶ä¼˜åŒ–ï¼ˆæ¨èå®ç°ï¼‰

**Redisé¢„å‡åº“å­˜**ï¼š

```java
// 1. æ·»åŠ Redisé¢„åˆ¤æ–­
String key = "seckill:stock:" + voucherId;
Long stock = stringRedisTemplate.opsForValue().decrement(key);

if (stock < 0) {
    // Redisåº“å­˜ä¸è¶³ï¼Œæ¢å¤
    stringRedisTemplate.opsForValue().increment(key);
    return Result.fail("åº“å­˜ä¸è¶³ï¼");
}

// 2. ç»§ç»­åŸæœ‰æµç¨‹ï¼ˆæ•°æ®åº“æ‰£åº“å­˜ï¼‰
boolean success = seckillVoucherService.update()
        .setSql("stock = stock - 1")
        .eq("voucher_id", voucherId)
        .gt("stock", 0)
        .update();

if (!success) {
    // æ•°æ®åº“æ‰£å‡å¤±è´¥ï¼Œæ¢å¤Redisåº“å­˜
    stringRedisTemplate.opsForValue().increment(key);
    return Result.fail("åº“å­˜ä¸è¶³ï¼");
}
```

**ä¼˜ç‚¹ï¼š**
- âœ… å®ç°ç®€å•ï¼ˆåªåŠ äº†10è¡Œä»£ç ï¼‰
- âœ… æ€§èƒ½æå‡æ˜¾è‘—ï¼ˆQPSå¯è¾¾5ä¸‡+ï¼‰
- âœ… å‡è½»æ•°æ®åº“å‹åŠ›ï¼ˆ90%è¯·æ±‚è¢«Redisæ‹¦æˆªï¼‰

---

### ç”Ÿäº§çº§ä¼˜åŒ–ï¼ˆé¢è¯•åŠ åˆ†ï¼‰

**å¼‚æ­¥ä¸‹å•** + **Luaè„šæœ¬** + **MQå‰Šå³°**

ä½†è¿™éœ€è¦å¼•å…¥RabbitMQ/RocketMQï¼Œå¤æ‚åº¦è¾ƒé«˜ã€‚

---

## ğŸ’¡ æ€»ç»“

### å½“å‰å®ç°çš„è¯„ä»·

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| æ­£ç¡®æ€§ | â­â­â­â­â­ | ä¸ä¼šè¶…å–ï¼Œé€»è¾‘æ­£ç¡® |
| æ€§èƒ½ | â­â­â­ | QPSçº¦3000ï¼Œä¸­ç­‰ |
| å¯é æ€§ | â­â­â­â­â­ | æ•°æ®åº“ä¿è¯åŸå­æ€§ |
| å¤æ‚åº¦ | â­â­â­â­â­ | ç®€å•æ˜“æ‡‚ |
| **ç»¼åˆ** | â­â­â­â­ | **å­¦ä¹ é¡¹ç›®å®Œå…¨å¤Ÿç”¨ï¼** |

### æˆ‘çš„å»ºè®®

1. **å½“å‰é˜¶æ®µ**ï¼šä¿æŒç°æœ‰å®ç°ï¼Œç†è§£ä¹è§‚é”åŸç†
2. **ä¸‹ä¸€æ­¥**ï¼šåŠ å…¥Redisé¢„å‡åº“å­˜ï¼ˆæå‡æ€§èƒ½ï¼‰
3. **é«˜çº§é˜¶æ®µ**ï¼šå­¦ä¹ å¼‚æ­¥ä¸‹å•ã€MQå‰Šå³°ç­‰

---

## ğŸ“ é¢è¯•å›ç­”æ¨¡æ¿

**é¢è¯•å®˜ï¼šä½ çš„ç§’æ€ç³»ç»Ÿå¦‚ä½•é˜²æ­¢è¶…å–ï¼Ÿ**

**å›ç­”ï¼š**

> æˆ‘ä½¿ç”¨äº†**ä¹è§‚é”æœºåˆ¶**é˜²æ­¢è¶…å–ï¼š
> 
> ```sql
> UPDATE tb_seckill_voucher 
> SET stock = stock - 1 
> WHERE voucher_id = ? AND stock > 0
> ```
> 
> è¿™ä¸ªSQLä¿è¯äº†ï¼š
> 1. `stock > 0` ç¡®ä¿ä¸ä¼šæ‰£æˆè´Ÿæ•°
> 2. `stock = stock - 1` æ˜¯æ•°æ®åº“çš„åŸå­æ“ä½œ
> 3. å¤šçº¿ç¨‹å¹¶å‘æ—¶ï¼Œæ•°æ®åº“çš„è¡Œé”ä¿è¯ä¸²è¡Œæ‰§è¡Œ
> 
> **ä¼˜ç‚¹**ï¼šç®€å•å¯é ï¼Œä¸ä¼šè¶…å–
> **ç¼ºç‚¹**ï¼šåœ¨æé«˜å¹¶å‘ä¸‹ï¼Œæ•°æ®åº“å‹åŠ›å¤§
> 
> **æ”¹è¿›æ–¹æ¡ˆ**ï¼š
> - åŠ å…¥Redisé¢„å‡åº“å­˜ï¼ŒQPSä»3000æå‡åˆ°5ä¸‡+
> - ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†ï¼Œå“åº”æ—¶é—´ä»100msé™åˆ°2ms
> - å®ç°Luaè„šæœ¬ä¿è¯åŸå­æ€§
> 
> åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œæˆ‘ä¼šæ ¹æ®ä¸šåŠ¡è§„æ¨¡é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆã€‚

---

æ­å–œï¼ä½ å·²ç»ç†è§£äº†ç§’æ€ä¼˜åŒ–çš„ç²¾é«“ï¼ğŸ‰

