# 密码登录功能测试指南

## 🎉 新增功能

现在支持**两种登录方式**：
1. ✅ **验证码登录**（原有功能，保持不变）
2. ✅ **密码登录**（新增功能）

---

## 📋 功能说明

### 1. 验证码登录（无需密码）
- 发送验证码到手机
- 使用验证码登录
- **自动注册**：如果用户不存在，自动创建账号

### 2. 密码登录（需要先设置密码）
- 使用手机号 + 密码登录
- 更方便，不需要每次获取验证码
- 密码加密存储（MD5 + 盐）

### 3. 设置/修改密码
- 需要验证码验证
- 密码长度：6-20位
- 可以随时修改密码

---

## 🚀 Postman 测试步骤

### 场景1：首次使用 - 验证码登录（注册）

#### Step 1: 发送验证码
```
POST http://localhost:8081/user/code?phone=13812345678
```

**响应：**
```json
{
    "success": true
}
```

**控制台查看验证码：**
```
发送验证码流程完成，验证码：123456
```

---

#### Step 2: 验证码登录（自动注册）
```
POST http://localhost:8081/user/login
Content-Type: application/json

Body (raw JSON):
{
    "phone": "13812345678",
    "code": "123456"
}
```

**响应：**
```json
{
    "success": true,
    "data": "f47e1c5a-8d9b-4f2e-a3c1-9b7e4f5d6c8a"
}
```

**说明：** `data` 是 token，保存备用

---

### 场景2：设置密码

#### Step 1: 发送验证码
```
POST http://localhost:8081/user/code?phone=13812345678
```

#### Step 2: 设置密码
```
POST http://localhost:8081/user/password?phone=13812345678&code=123456&password=123456
```

**响应：**
```json
{
    "success": true,
    "data": "密码设置成功"
}
```

**✅ 现在可以使用密码登录了！**

---

### 场景3：密码登录

```
POST http://localhost:8081/user/login
Content-Type: application/json

Body (raw JSON):
{
    "phone": "13812345678",
    "password": "123456"
}
```

**响应：**
```json
{
    "success": true,
    "data": "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
}
```

**说明：** 返回新的 token

---

### 场景4：修改密码

#### Step 1: 发送验证码
```
POST http://localhost:8081/user/code?phone=13812345678
```

#### Step 2: 修改密码（需要验证码验证）
```
POST http://localhost:8081/user/password?phone=13812345678&code=123456&password=newpassword123
```

**响应：**
```json
{
    "success": true,
    "data": "密码设置成功"
}
```

**✅ 密码已修改，使用新密码登录**

---

## 🎯 Postman 快速测试集合

### Collection: 密码登录功能测试

#### 1️⃣ 发送验证码
```
POST http://localhost:8081/user/code?phone=13800138000
```

#### 2️⃣ 验证码登录（注册）
```
POST http://localhost:8081/user/login
Content-Type: application/json

{
    "phone": "13800138000",
    "code": "{{验证码}}"
}
```

#### 3️⃣ 设置密码
```
POST http://localhost:8081/user/password
?phone=13800138000
&code={{验证码}}
&password=123456
```

#### 4️⃣ 密码登录
```
POST http://localhost:8081/user/login
Content-Type: application/json

{
    "phone": "13800138000",
    "password": "123456"
}
```

#### 5️⃣ 查看个人信息
```
GET http://localhost:8081/user/me
Headers:
  authorization: {{token}}
```

#### 6️⃣ 登出
```
POST http://localhost:8081/user/logout
Headers:
  authorization: {{token}}
```

---

## 📊 Body 格式说明

### 验证码登录
```json
{
    "phone": "13812345678",
    "code": "123456"
}
```

### 密码登录
```json
{
    "phone": "13812345678",
    "password": "123456"
}
```

### ⚠️ 注意：
- **不能同时传 code 和 password**
- 优先级：`code` > `password`
- 如果都传了，使用验证码登录

---

## 🔐 密码安全

### 加密方式
- **算法**: MD5 + 盐（Salt）
- **格式**: `{salt}@{md5(password+salt)}`
- **示例**: `aB3dE5fG7hI9jK1lM@3e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b`

### 数据库存储
```sql
SELECT id, phone, password FROM tb_user WHERE phone = '13812345678';
```

**结果：**
```
id: 1
phone: 13812345678
password: aB3dE5fG7hI9jK1lM@3e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b
```

**说明：** 密码加密后存储，无法反向解密

---

## ✅ 测试验证

### 验证1：密码登录成功
```bash
# 1. 设置密码
POST /user/password?phone=13800138000&code=123456&password=abc123

# 2. 密码登录
POST /user/login
{
    "phone": "13800138000",
    "password": "abc123"
}

# 预期：返回 token
```

---

### 验证2：密码错误
```bash
POST /user/login
{
    "phone": "13800138000",
    "password": "wrongpassword"
}

# 预期：
{
    "success": false,
    "errorMsg": "手机号或密码错误"
}
```

---

### 验证3：用户不存在
```bash
POST /user/login
{
    "phone": "18800000000",  # 不存在的手机号
    "password": "123456"
}

# 预期：
{
    "success": false,
    "errorMsg": "手机号或密码错误"
}
```

---

### 验证4：未设置密码
```bash
# 1. 验证码登录（注册）
POST /user/login
{
    "phone": "13900139000",
    "code": "123456"
}

# 2. 立即尝试密码登录（未设置密码）
POST /user/login
{
    "phone": "13900139000",
    "password": "123456"
}

# 预期：
{
    "success": false,
    "errorMsg": "手机号或密码错误"
}
```

---

### 验证5：密码格式校验
```bash
# 密码太短（<6位）
POST /user/password?phone=13800138000&code=123456&password=12345

# 预期：
{
    "success": false,
    "errorMsg": "密码长度必须为6-20位！"
}

# 密码太长（>20位）
POST /user/password?phone=13800138000&code=123456&password=123456789012345678901

# 预期：
{
    "success": false,
    "errorMsg": "密码长度必须为6-20位！"
}
```

---

## 🎓 技术要点

### 1. 登录方式判断逻辑

```java
if (code != null && !code.isEmpty()) {
    // 验证码登录（优先）
    return loginByCode(phone, code);
} else if (password != null && !password.isEmpty()) {
    // 密码登录
    return loginByPassword(phone, password);
} else {
    return Result.fail("请输入验证码或密码");
}
```

---

### 2. 密码加密存储

```java
// 加密
String encodedPassword = PasswordEncoder.encode("123456");
// 结果: aB3dE5fG7hI9jK1lM@3e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b

// 验证
boolean matches = PasswordEncoder.matches(encodedPassword, "123456");
// 结果: true
```

---

### 3. 登录流程

```
用户请求
    ↓
判断登录方式（code 或 password）
    ↓
验证码登录 ←→ 密码登录
    ↓
查询/创建用户
    ↓
生成 Token
    ↓
保存到 Redis
    ↓
返回 Token
```

---

## 🐛 常见问题

### Q1: "用户不存在，请先注册"

**原因：** 使用密码登录，但用户未注册

**解决：**
1. 先使用验证码登录（自动注册）
2. 然后设置密码
3. 再使用密码登录

---

### Q2: "手机号或密码错误"

**可能原因：**
1. 密码输入错误
2. 用户未设置密码
3. 手机号不存在

**排查：**
```sql
-- 查询用户
SELECT id, phone, password FROM tb_user WHERE phone = '13812345678';

-- 如果 password 为 NULL，说明未设置密码
```

---

### Q3: 验证码登录和密码登录有什么区别？

| 特性 | 验证码登录 | 密码登录 |
|------|-----------|---------|
| 是否需要验证码 | ✅ | ❌ |
| 自动注册 | ✅ | ❌ |
| 便捷性 | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 安全性 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |

**建议：**
- 首次使用：验证码登录（自动注册）
- 日常使用：密码登录（方便快捷）
- 忘记密码：用验证码重置

---

### Q4: 如何重置密码？

**方法1：使用设置密码接口（推荐）**
```bash
POST /user/password?phone=13812345678&code=123456&password=newpassword
```

**方法2：直接修改数据库（不推荐）**
```sql
-- 生成新密码（需要手动计算）
UPDATE tb_user SET password = '...' WHERE phone = '13812345678';
```

---

## 💡 使用建议

### 对于开发测试：
1. ✅ **使用密码登录** - 不需要每次获取验证码
2. ✅ 设置简单密码（如 `123456`）
3. ✅ 保存 token 到 Postman 环境变量

### 对于生产环境：
1. ✅ 强制密码复杂度（大小写+数字+特殊字符）
2. ✅ 密码加盐加密（已实现）
3. ✅ 登录失败次数限制（待实现）
4. ✅ 短信验证码限流（待实现）

---

## 🎉 总结

### 新增接口

| 接口 | 方法 | 说明 |
|------|------|------|
| `/user/password` | POST | 设置/修改密码 |

### 修改接口

| 接口 | 方法 | 变化 |
|------|------|------|
| `/user/login` | POST | 支持密码登录 |

### 技术亮点

1. ✅ **两种登录方式** - 验证码 + 密码
2. ✅ **密码加密** - MD5 + 盐
3. ✅ **自动注册** - 验证码登录时自动创建用户
4. ✅ **代码重构** - 提取私有方法，代码更清晰
5. ✅ **日志记录** - 详细的操作日志

---

恭喜！🎉 密码登录功能开发完成！

